{% extends "base.html" %}

{% block title %}ØªØ­Ù„ÙŠÙ„ Ù…Ù„ÙØ§Øª CSV{% endblock %}

{% block content %}
<section class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <h2 class="h4 mb-3">ğŸ“¤ Ø±ÙØ¹ Ù…Ù„Ù CSV</h2>
            <form action="{{ url_for('index') }}" method="post" enctype="multipart/form-data" class="row gy-3">
                <div class="col-md-6">
                    <label for="file" class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù„Ù</label>
                    <input class="form-control" type="file" accept=".csv" name="file" id="file" required>
                    <div class="form-text">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù: 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª</div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Ø±ÙØ¹ ÙˆØªØ­Ù„ÙŠÙ„</button>
                </div>
                {% if stats %}
                <div class="col-md-3 d-flex align-items-end">
                    <a href="{{ url_for('reset') }}" class="btn btn-outline-danger w-100">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ</a>
                </div>
                {% endif %}
            </form>
        </div>
    </div>
</section>

{% if stats %}
<section class="mb-4">
    <div class="section-title mb-3">
        <span class="icon">ğŸ“Š</span>
        <h2 class="h4 m-0">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
    </div>
    <div class="row g-3">
        <div class="col-md-3">
            <div class="card-metric">
                <h3 class="h6 text-muted">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ</h3>
                <p class="display-6">{{ "{:,}".format(stats.num_rows) }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-metric">
                <h3 class="h6 text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</h3>
                <p class="display-6">{{ "{:,}".format(stats.num_columns) }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-metric">
                <h3 class="h6 text-muted">Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙƒØ±Ø±Ø©</h3>
                <p class="display-6">{{ "{:,}".format(stats.num_duplicates) }}</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-metric">
                <h3 class="h6 text-muted">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h3>
                <p class="display-6">{{ "{:,}".format(stats.complete_columns_count) }}</p>
                <small class="text-muted d-block mt-2">
                    ØªÙ… Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„:
                    {{ excluded_columns|select('in', stats.column_names)|join(', ') if excluded_columns else 'Ù„Ø§ ØªÙˆØ¬Ø¯' }}
                </small>
            </div>
        </div>
    </div>
</section>

<section class="mb-4">
    <div class="section-title mb-3">
        <span class="icon">ğŸ‘ï¸</span>
        <h2 class="h4 m-0">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body table-preview">
            {{ preview_html|safe }}
        </div>
    </div>
</section>

<section class="mb-4">
    <div class="section-title mb-3">
        <span class="icon">âœ…</span>
        <h2 class="h4 m-0">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</h2>
    </div>
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <form method="get" class="row gy-3">
                <div class="col-md-6">
                    <label for="column_search" class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</label>
                    <input type="text" class="form-control" id="column_search" name="column_search" placeholder="Ø§ÙƒØªØ¨ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ (Ù…Ø«Ø§Ù„: Id, BookNumber...)" value="{{ column_query }}">
                </div>
                <div class="col-md-4">
                    <label for="word_search" class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙƒÙ„Ù…Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                    <input type="text" class="form-control" id="word_search" name="word_search" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ù„Ø§ØŒ nullØŒ ÙØ§Ø±Øº..." value="{{ word_query }}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-secondary w-100">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«</button>
                </div>
            </form>
        </div>
    </div>

    {% if column_query %}
        {% if stats.filtered_columns %}
            <div class="alert alert-info">
                ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {{ stats.filtered_columns|length }} Ø¹Ù…ÙˆØ¯ ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø« "{{ column_query }}".
            </div>
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle">
                            <thead>
                                <tr>
                                    <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                                    <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                    <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©</th>
                                    <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</th>
                                    <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for col in stats.filtered_columns %}
                                <tr>
                                    <td>{{ col.name }}</td>
                                    <td>{{ "âœ… Ù…ÙƒØªÙ…Ù„" if col.is_complete else "âŒ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„" }}</td>
                                    <td>{{ "{:,}".format(col.complete_count) }}</td>
                                    <td>{{ "{:,}".format(col.missing_count) }}</td>
                                    <td>{{ "{:.2f}%".format(col.completion_rate) }}</td>
                                    <td>{{ col.dtype }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-warning">
                Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø£Ø¹Ù…Ø¯Ø© ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø« "{{ column_query }}".
            </div>
        {% endif %}
    {% else %}
        {% if stats.complete_columns %}
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <h3 class="h5 mb-3">Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙÙ‚Ø·</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for col in stats.complete_columns %}
                            <tr>
                                <td>{{ col }}</td>
                                <td>{{ "{:,}".format(stats.num_rows) }}</td>
                                <td>100%</td>
                                <td>{{ stats.dtypes[col] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% else %}
        <div class="alert alert-warning">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ù…Ø¯Ø© Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¶Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©.
        </div>
        {% endif %}
    {% endif %}

    {% if column_query == "" and stats.all_columns %}
    <details class="mb-3">
        <summary class="btn btn-outline-primary">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</summary>
        <div class="card border-0 shadow-sm mt-3">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§ÙƒØªÙ…Ø§Ù„</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for col in stats.all_columns %}
                            <tr>
                                <td>{{ col.name }}</td>
                                <td>{{ "âœ… Ù…ÙƒØªÙ…Ù„" if col.is_complete else "âŒ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„" }}</td>
                                <td>{{ "{:,}".format(col.complete_count) }}</td>
                                <td>{{ "{:,}".format(col.missing_count) }}</td>
                                <td>{{ "{:.2f}%".format(col.completion_rate) }}</td>
                                <td>{{ col.dtype }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </details>
    {% endif %}
</section>

{% if word_query %}
<section class="mb-4">
    <div class="section-title mb-3">
        <span class="icon">ğŸ”</span>
        <h2 class="h4 m-0">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙ„Ù…Ø© "{{ word_query }}"</h2>
    </div>
    {% if stats.word_results %}
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="card-metric">
                    <h3 class="h6 text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±</h3>
                    <p class="display-6">{{ "{:,}".format(stats.word_total_occurrences) }}</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card-metric">
                    <h3 class="h6 text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø©</h3>
                    <p class="display-6">{{ "{:,}".format(stats.word_results|length) }}</p>
                </div>
            </div>
        </div>
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                                <th>Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¸Ù‡ÙˆØ±</th>
                                <th>Ù†Ø³Ø¨Ø© Ø§Ù„Ø¸Ù‡ÙˆØ±</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stats.word_results %}
                            <tr>
                                <td>{{ item.name }}</td>
                                <td>{{ "{:,}".format(item.count) }}</td>
                                <td>{{ "{:.2f}%".format(item.percentage) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% if stats.word_examples %}
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h3 class="h5 mb-3">Ø£Ù…Ø«Ù„Ø© Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle examples-table">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„ØµÙ</th>
                                <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for example in stats.word_examples %}
                            <tr>
                                <td>{{ example.name }}</td>
                                <td>{{ example.row_number }}</td>
                                <td title="{{ example.value }}">{{ example.value }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    {% else %}
        <div class="alert alert-warning">
            Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø© "{{ word_query }}" ÙÙŠ Ø£ÙŠ Ù…Ù† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©.
        </div>
    {% endif %}
</section>
{% endif %}

<section class="mb-4">
    <div class="section-title mb-3">
        <span class="icon">ğŸ”</span>
        <h2 class="h4 m-0">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</h2>
    </div>
    <div class="row g-3 mb-3">
        <div class="col-md-6">
            <div class="card-metric">
                <h3 class="h6 text-muted">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</h3>
                <p class="display-6">{{ "{:,}".format(stats.total_missing) }}</p>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-metric">
                <h3 class="h6 text-muted">Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</h3>
                <p class="display-6">{{ "{:.2f}%".format(stats.missing_percentage) }}</p>
            </div>
        </div>
    </div>
    {% if stats.missing_breakdown %}
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-bordered align-middle">
                    <thead>
                        <tr>
                            <th>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø±ØºØ©</th>
                            <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stats.missing_breakdown %}
                        <tr>
                            <td>{{ item.name }}</td>
                            <td>{{ "{:,}".format(item.missing_count) }}</td>
                            <td>{{ "{:.2f}%".format(item.percentage) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-success">
        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.
    </div>
    {% endif %}
</section>

<section class="mb-4">
    <div class="section-title mb-3">
        <span class="icon">â„¹ï¸</span>
        <h2 class="h4 m-0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h2>
    </div>
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="row gy-3">
                <div class="col-md-6">
                    <h3 class="h6 text-muted mb-2">Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©</h3>
                    <div class="d-flex flex-wrap gap-2">
                        {% for name in stats.column_names %}
                            <span class="badge bg-secondary">{{ name }}</span>
                        {% endfor %}
                    </div>
                </div>
                <div class="col-md-6">
                    <h3 class="h6 text-muted mb-2">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <ul class="list-group list-group-flush">
                        {% for name, dtype in stats.dtypes.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ name }}</span>
                            <span class="badge bg-light text-dark">{{ dtype }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

{% endblock %}

